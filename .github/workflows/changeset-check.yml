name: Changeset Check

on:
  pull_request:
    branches:
      - dev
      - prev
      - main
    paths:
      - "Project/**"

concurrency:
  group: changeset-check-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  changeset:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Detect changeset check scope
        id: scope
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --depth=1
          changed="$(git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- Project)"
          echo "$changed"

          requires_changeset="false"
          has_changeset_file="false"
          while IFS= read -r file; do
            [ -z "$file" ] && continue

            # Changeset files always require validation.
            if [[ "$file" == Project/.changeset/* ]]; then
              has_changeset_file="true"
              requires_changeset="true"
              continue
            fi

            # Docs-only paths are excluded from changeset validation.
            if [[ "$file" == Project/docs/* ]]; then
              continue
            fi
            if [[ "$file" == *.md || "$file" == *.mdx ]]; then
              continue
            fi

            requires_changeset="true"
          done <<< "$changed"

          echo "requires_changeset=$requires_changeset" >> "$GITHUB_OUTPUT"
          echo "has_changeset_file=$has_changeset_file" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        if: steps.scope.outputs.requires_changeset == 'true'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 24.13.1

      - name: Setup pnpm
        if: steps.scope.outputs.requires_changeset == 'true'
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: 10

      - name: Install
        if: steps.scope.outputs.requires_changeset == 'true'
        run: pnpm -C Project install --frozen-lockfile

      - name: Skip docs-only changes
        if: steps.scope.outputs.requires_changeset != 'true'
        run: echo "Docs-only changes detected in Project/. Skipping changeset validation."

      - name: Verify changeset
        if: steps.scope.outputs.requires_changeset == 'true'
        id: verify
        continue-on-error: true
        shell: bash
        run: |
          set +e
          output="$(NO_COLOR=1 FORCE_COLOR=0 pnpm -C Project exec changeset status --since=origin/${{ github.base_ref }} 2>&1)"
          code=$?
          {
            echo "exit_code=$code"
            echo "output<<EOF"
            echo "$output"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          exit $code

      - name: Upsert changeset comment
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        env:
          REQUIRES_CHANGESET: ${{ steps.scope.outputs.requires_changeset }}
          HAS_CHANGESET_FILE: ${{ steps.scope.outputs.has_changeset_file }}
          VERIFY_EXIT_CODE: ${{ steps.verify.outputs.exit_code }}
          VERIFY_OUTPUT: ${{ steps.verify.outputs.output }}
        with:
          script: |
            const marker = "<!-- changeset-check-comment -->";
            const issue_number = context.payload.pull_request.number;
            const { owner, repo } = context.repo;
            const base = context.payload.pull_request.base.ref;
            const requiresChangeset = process.env.REQUIRES_CHANGESET === "true";
            const hasChangesetFile = process.env.HAS_CHANGESET_FILE === "true";
            const verifyPassed = process.env.VERIFY_EXIT_CODE === "0";
            const changesetGuide = [
              "### Changeset quick guide",
              "",
              "Use this format in `Project/.changeset/<name>.md`:",
              "",
              "```md",
              "---",
              "\"neon-conductor\": patch|minor|major|none",
              "---",
              "",
              "Short summary of the change for release notes.",
              "```",
              "",
              "When to use each bump:",
              "- `patch`: backwards-compatible bug fixes or small improvements",
              "- `minor`: backwards-compatible new features",
              "- `major`: breaking changes",
              "- `none`: no version bump for this package, but keep release note context",
            ].join("\n");

            const summaryLines = [
              marker,
              "## Changeset radar",
              "",
              `- Base branch: \`${base}\``,
              `- Requires changeset: ${requiresChangeset ? "yes" : "no"}`,
              `- Changeset detected: ${hasChangesetFile ? "yes" : "no"}`,
            ];

            let body;
            if (!requiresChangeset) {
              body = [
                ...summaryLines,
                "- Result: skipped",
                "",
                "No changeset needed this round. Docs-only/non-release changes detected in `Project/`.",
                "",
                changesetGuide,
              ].join("\n");
            } else if (verifyPassed) {
              body = [
                ...summaryLines,
                "- Result: passed",
                "",
                hasChangesetFile
                  ? "Changeset detected and validated. Nice work."
                  : "Changeset validation passed.",
                "",
                changesetGuide,
              ].join("\n");
            } else {
              const stripAnsi = (input) =>
                input
                  .replace(/\u001b\[[0-9;]*[A-Za-z]/g, "")
                  .replace(/\uFFFD\[[0-9;]*[A-Za-z]/g, "");
              const raw = stripAnsi(process.env.VERIFY_OUTPUT || "No output captured");
              const clipped =
                raw.length > 6000 ? `${raw.slice(0, 6000)}\n...truncated...` : raw;
              body = [
                ...summaryLines,
                "- Result: failed",
                "",
                hasChangesetFile
                  ? "Changeset detected, but validation tripped on details."
                  : "Changeset required, but none was detected yet.",
                "",
                "```text",
                clipped,
                "```",
                "",
                changesetGuide,
              ].join("\n");
            }

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((c) => (c.body || "").includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

      - name: Fail when changeset check fails
        if: steps.scope.outputs.requires_changeset == 'true' && steps.verify.outputs.exit_code != '0'
        run: exit 1
